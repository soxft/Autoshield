<style>
    .autoshield-table table tbody tr td span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 580px;
        display: block;
    }

    .plugin_about {
        padding: 15px 30px;
        line-height: 26px;
        background: #f0f0f1;
        border-radius: 5px;
        border: 1px solid #ffffff;
    }

    .butt {
        display: inline-block;
        padding-top: 0;
        height: 1.4em;
        margin-bottom: 0
    }
</style>
<div class="bt-form">
    <div class="bt-w-main">
        <!--菜单部分-->
        <div class="bt-w-menu">
            <p class="bgw" onclick="autoshield.get_index()">概览</p>
            <p onclick="autoshield.get_setting()">密钥设置</p>
            <p onclick="autoshield.get_safe()">防护设置</p>
            <p onclick="autoshield.get_domain()">域名管理</p>
            <p onclick="autoshield.get_runlog()">运行日志</p>
            <p onclick="autoshield.get_errorlog()">错误日志</p>
            <p onclick="autoshield.get_about()">关于</p>
        </div>
        <!--内容部分-->
        <div class="bt-w-con pd15">
            <div class="plugin_body"></div>
        </div>
    </div>
</div>
<!--JS脚本部分，不要将JS脚本写在其它地方-->
<script type="text/javascript">

    $('.layui-layer-page').css({ 'width': '700px' });

    $(".bt-w-menu p").click(function () {
        $(this).addClass('bgw').siblings().removeClass('bgw')
    });

    var autoshield = {
        get_index: function () {
            html = "\
                <div class='soft-man-con bt-form'>\
                    <p class='status'>当前状态：<span class='runStatus'></span></p>\
                </div>\
                <div class='button'></div>\
            "
            startingHtml = "\
                <span>开启</span><span style='color: #20a53a; margin-left: 3px;' class='glyphicon glyphicon glyphicon-play'></span> </p>\
                <div class='sfm-opt'>\
                    <button class='btn btn-default btn-sm' onclick='stop()'>停止</button>\
                    <button class='btn btn-default btn-sm' onclick='restart()')'>重启</button>\
                </div>"
            stopingHtml = "\
                <span>关闭</span > <span style='color: red; margin-left: 3px;' class='glyphicon glyphicon-pause'></span> </p >\
                <div class='sfm-opt'>\
                    <button class='btn btn-default btn-sm' onclick='start()'>启动</button>\
                </div>"

            $('.plugin_body').html(html);
            var index = layer.load(0);
            request_plugin('get_status', {}, function (data) { //获取状态
                if (data.runStatus) {
                    $('.runStatus').html(startingHtml)
                } else {
                    $('.runStatus').html(stopingHtml)
                }
            }, index = index);
        },
        get_setting: function () {
            html = "\
                <div class='autoshield_setting'>\
                    <div class='line'>\
                        <div class='line'>\
                        <span class='tname'>绑定邮箱</span>\
                            <div class='info-r'>\
                                <input id='cfemail' placeholder='请输入您的Cloudflare绑定的邮箱地址' type='text' class='bt-input-text mr5' style='width: 430px;'>\
                                <br />\
                                <span style='color: rgb(153, 153, 153);'>请输入您的Cloudflare绑定的邮箱地址</span>\
                            </div>\
                        </div>\
                        <span class='tname'>全局API密钥</span>\
                            <div class='info-r'>\
                                <input id='cfkey' placeholder='请输入Cloudflare global API 密钥' type='text' class='bt-input-text mr5' style='width: 430px;'>\
                                <br />\
                                <span style='color: rgb(153, 153, 153);'>请输入Cloudflare global api key，获取方式详见关于界面</span>\
                            </div>\
                        </div>\
                        <div class='line'>\
                        <span class='tname'></span>\
                            <div class='info-r'>\
                                <button onclick='save_setting()' class='btn btn-success btn-sm'>保存配置</button>\
                            </div>\
                        </div>\
                    </div>\
                </div>"
            $('.plugin_body').html(html);
            var index = layer.load(0);
            request_plugin('get_setting', {}, function (rdata) {
                $('.autoshield_setting #cfemail').val(rdata.email);
                $('.autoshield_setting #cfkey').val(rdata.key);
            }, index = index);
        },
        get_about: function () {
            var index = layer.load(0);
            request_plugin('get_about', {}, function (rdata) {
                $('.plugin_body').html(rdata);
            }, index = index);
        },
        get_safe: function () {
            html = "\
                <div class='line'>\
                    <span class='tname'>等待时间</span>\
                    <div class='info-r'>\
                        <input id='waittime' placeholder='300' type='number' class='bt-input-text mr5' value='$this->waittime' style='width: 100px;'> <span style='color: rgb(153, 153, 153);'>* 被攻击后,负载恢复正常后关闭5秒盾的等待时间(单位:秒)</span>\
                    </div>\
                </div>\
                <div class='line'><span class='tname'>检测周期</span>\
                    <div class='info-r'>\
                        <input id='sleeptime' placeholder='5' type='number' class='bt-input-text mr5' value='$this->sleeptime' style='width: 100px;'> <span style='color: rgb(153, 153, 153);'>* 每几秒检测一次服务器负载(单位:秒)</span>\
                    </div>\
                </div>\
                <div class='line'><span class='tname'>检测时间</span>\
                    <div class='info-r'>\
                        <input id='checktime' placeholder='30' type='number' class='bt-input-text mr5' value='$this->checktime' style='width: 100px;'> <span style='color: rgb(153, 153, 153);'>* 连续超过负载阀值多长时间自动开盾(单位:秒)</span>\
                    </div>\
                </div>\
                <div class='line'><span class='tname'>负载阀值</span>\
                    <div class='info-r'>\
                        <input id='checktime' placeholder='30' type='number' class='bt-input-text mr5' value='$this->checktime' style='width: 100px;'> <span style='color: rgb(153, 153, 153);'>* 服务器负载阀值,超过该值后等待检测时间后自动开盾</span>\
                    </div>\
                </div>\
                <div class='line'>\
                    <span class='tname'></span>\
                        <div class='info-r'>\
                            <button onclick='save_safe()' class='btn btn-success btn-sm'>保存配置</button>\
                        </div>\
                    </div>\
                </div>\
                <div style='height:10px'></div>\
                <span style='color: rgb(153, 153, 153);'>* 当前服务器的逻辑CPU个数为: <span id='cpuCount'>-</span>个, 安全负载为<span id='safeLoad'>-</span></span>\
                "
            $('.plugin_body').html(html);
            var index = layer.load(0);
            request_plugin('get_safe', {}, function (rdata) {
                console.log(rdata)
            }, index = index);
            request_plugin('get_safe_load', {}, function (rdata) {
                console.log(rdata)
                $('#cpuCount').text(rdata.cpu_count)
                $('#safeLoad').text(rdata.safe_load)
            });
        },
        get_domain: function () {
            var index = layer.load(0);
            request_plugin('get_domain', {}, function (rdata) {
                $('.plugin_body').html(rdata);
            });
        },
        get_errorlog: function () {
            var index = layer.load(0);
            request_plugin('get_errorlog', {}, function (rdata) {
                $('.plugin_body').html(rdata);
            });
        },
        get_runlog: function () {
            var index = layer.load(0);
            request_plugin('get_runlog', {}, function (rdata) {
                $('.plugin_body').html(rdata);
            });
        },
    }

    // 保存设置
    function save_setting() {
        var cfemail = $('.autoshield_setting #cfemail').val();
        var cfkey = $('.autoshield_setting #cfkey').val();

        var load = layer.load();
        request_plugin('set_setting', { email: cfemail, key: cfkey }, (data) => {
            layer.close(load)
            // 成功 > 请求所有域名
            var index = layer.msg('获取用户域名列表', { icon: 16, time: 0, shade: 0.3 });
            request_plugin('refresh_domain', {}, (data) => {
                var index = layer.msg('获取域名防御等级(此过程可能耗时较长)', { icon: 16, time: 0, shade: 0.3 });
                request_plugin('refresh_domain_security', {}, (data) => {
                    layer.msg('获取成功!', { icon: 1, time: 1500, shade: 0.3 })
                }, index = index, timeout = 0)
            }, index = index);  // 成功 > 尝试请求域名目前防御等级
        }, index = load);
    }

    // 保存安全配置
    function save_safe() {

    }

    function request_plugin(function_name, args, callback, index = null, timeout = 15000) {
        $.ajax({
            type: 'POST',
            url: '/plugin?action=a&s=' + function_name + '&name=autoshield',
            data: args,
            timeout: timeout,
            success: function (rdata) {
                if (!callback) {
                    layer.msg(rdata.msg, { icon: rdata.status ? 1 : 2 });
                    return;
                }
                if (rdata === null) {
                    layer.open({
                        type: 1,
                        title: '错误提示',
                        area: ['50vh', '70vh'],
                        content: "<div style='padding: 15px;'><div style='padding: 5px;border: 0.2px solid grey;border-radius:5px'>func: " + function_name + "<br> args: " + JSON.stringify(args) + "<br/>返回值为null</div><br/><p>您可以在宝塔论坛对应帖子询问以获得支持</p></div>"
                    });
                } else if (rdata.status != undefined && !rdata.status) {
                    layer.open({
                        type: 1,
                        title: '错误提示',
                        area: ['50vh', '70vh'],
                        content: "<div style='padding: 15px;'><div style='padding: 5px;border: 0.2px solid grey;border-radius:5px'>" + rdata.msg + "</div><br/><p>您可以在宝塔论坛对应帖子询问以获得支持</p></div>"
                    });
                } else if (rdata.code == -1) {
                    layer.msg(rdata.msg, { icon: 2 })
                } else if (rdata.code == -2) {
                    layer.open({
                        type: 1,
                        title: rdata.msg,
                        area: ['50vh', '70vh'],
                        content: "<div style='padding: 15px;'><p style='font-size:18px' >" + rdata.msg + "</p><br />以下内容可能会提供帮助:<br /><br /><div style='padding: 5px;border: 0.2px solid grey;border-radius:5px'>" + rdata.tip + "</div></div>"
                    });
                } else {
                    return callback(rdata);
                }
            },
            error: function (ex) {
                layer.msg('请求过程发现错误!', { icon: 2 });
                return callback(ex);
            },
            complete: function (XMLHttpRequest, status) {
                if (status == 'timeout') {
                    layer.msg('请求超时,请重试...', { icon: 2 });
                }
                if (index) layer.close(index)
            }
        });
    }

    //第一次打开窗口时调用
    autoshield.get_index();

</script>